import React, { useState, useEffect, useRef } from 'react';
import { Play, RotateCcw, ChevronRight, Star, Book, Globe, CheckCircle, Menu, X, Eraser, Printer, Volume2 } from 'lucide-react';

/* =========================================
   1. DATA GENERATOR & RAW DATA
   (Membuat ribuan level secara otomatis)
   ========================================= */

// Helper: Membuat Stage Otomatis (1 Huruf = 1 Stage)
const createStages = (chars) => {
  return chars.map((char, index) => ({
    id: index + 1,
    title: `${char.symbol} - ${char.read}`,
    newChars: [char]
  }));
};

// --- DATA MENTAH HURUF ---

const CHARS_ALPHABET = [
  { id: 'A', symbol: "A", read: "A", hint: "Gunung dengan sabuk." },
  { id: 'B', symbol: "B", read: "B", hint: "Tiang lurus dua perut." },
  { id: 'C', symbol: "C", read: "C", hint: "Bulan sabit." },
  { id: 'D', symbol: "D", read: "D", hint: "Perut besar." },
  { id: 'E', symbol: "E", read: "E", hint: "Sisir tiga gigi." },
  { id: 'F', symbol: "F", read: "F", hint: "Bendera." },
  { id: 'G', symbol: "G", read: "G", hint: "C ada kursinya." },
  { id: 'H', symbol: "H", read: "H", hint: "Tangga." },
  { id: 'I', symbol: "I", read: "I", hint: "Tiang listrik." },
  { id: 'J', symbol: "J", read: "J", hint: "Kail pancing." },
  { id: 'K', symbol: "K", read: "K", hint: "Tangan ke atas, kaki ke bawah." },
  { id: 'L', symbol: "L", read: "L", hint: "Siku-siku." },
  { id: 'M', symbol: "M", read: "M", hint: "Dua gunung." },
  { id: 'N', symbol: "N", read: "N", hint: "Petir/Zigzag." },
  { id: 'O', symbol: "O", read: "O", hint: "Donat." },
  { id: 'P', symbol: "P", read: "P", hint: "Kepala di atas." },
  { id: 'Q', symbol: "Q", read: "Q", hint: "O punya ekor." },
  { id: 'R', symbol: "R", read: "R", hint: "P punya kaki." },
  { id: 'S', symbol: "S", read: "S", hint: "Ular meliuk." },
  { id: 'T', symbol: "T", read: "T", hint: "Palu." },
  { id: 'U', symbol: "U", read: "U", hint: "Gelas." },
  { id: 'V', symbol: "V", read: "V", hint: "Burung terbang." },
  { id: 'W', symbol: "W", read: "W", hint: "M terbalik." },
  { id: 'X', symbol: "X", read: "X", hint: "Silang." },
  { id: 'Y', symbol: "Y", read: "Y", hint: "Ketapel." },
  { id: 'Z', symbol: "Z", read: "Z", hint: "Zigzag tajam." }
];

const CHARS_ARABIC = [
  { id: 'alif', symbol: "Ø§", read: "Alif", hint: "Tongkat lurus." },
  { id: 'ba', symbol: "Ø¨", read: "Ba", hint: "Perahu titik satu di bawah." },
  { id: 'ta', symbol: "Øª", read: "Ta", hint: "Perahu titik dua di atas." },
  { id: 'tsa', symbol: "Ø«", read: "Tsa", hint: "Perahu titik tiga." },
  { id: 'jim', symbol: "Ø¬", read: "Jim", hint: "Perut buncit titik di dalam." },
  { id: 'ha', symbol: "Ø­", read: "Ha", hint: "Perut buncit kosong." },
  { id: 'kha', symbol: "Ø®", read: "Kha", hint: "Perut buncit titik di atas." },
  { id: 'dal', symbol: "Ø¯", read: "Dal", hint: "Mulut terbuka." },
  { id: 'dzal', symbol: "Ø°", read: "Dzal", hint: "Dal pakai titik." },
  { id: 'ra', symbol: "Ø±", read: "Ra", hint: "Perosotan." },
  { id: 'zai', symbol: "Ø²", read: "Zai", hint: "Perosotan pakai titik." },
  { id: 'sin', symbol: "Ø³", read: "Sin", hint: "Gigi tiga perut besar." },
  { id: 'syin', symbol: "Ø´", read: "Syin", hint: "Sin pakai titik tiga." },
  { id: 'shad', symbol: "Øµ", read: "Shad", hint: "Kepala lonjong perut besar." },
  { id: 'dhad', symbol: "Ø¶", read: "Dhad", hint: "Shad pakai titik." },
  { id: 'tha', symbol: "Ø·", read: "Tha", hint: "Kepala lonjong pakai tiang." },
  { id: 'zha', symbol: "Ø¸", read: "Zha", hint: "Tha pakai titik." },
  { id: 'ain', symbol: "Ø¹", read: "'Ain", hint: "C kecil dan C besar." },
  { id: 'ghain', symbol: "Øº", read: "Ghain", hint: "Ain pakai titik." },
  { id: 'fa', symbol: "Ù", read: "Fa", hint: "Kepala bulat leher pendek." },
  { id: 'qof', symbol: "Ù‚", read: "Qof", hint: "Kepala bulat perut dalam." },
  { id: 'kaf', symbol: "Ùƒ", read: "Kaf", hint: "S kecil di atas kursi." },
  { id: 'lam', symbol: "Ù„", read: "Lam", hint: "Kail pancing besar." },
  { id: 'mim', symbol: "Ù…", read: "Mim", hint: "Kepala bulat ekor bawah." },
  { id: 'nun', symbol: "Ù†", read: "Nun", hint: "Mangkuk titik satu." },
  { id: 'waw', symbol: "Ùˆ", read: "Waw", hint: "Kepala bulat meluncur." },
  { id: 'ha_besar', symbol: "Ù‡", read: "Ha", hint: "Bulatan simpul." },
  { id: 'ya', symbol: "ÙŠ", read: "Ya", hint: "Angsa titik dua." }
];

const CHARS_HANGUL = [
  // Konsonan (14)
  { id: 'g', symbol: "ã„±", read: "Giyok (G)", hint: "Pistol." },
  { id: 'n', symbol: "ã„´", read: "Nieun (N)", hint: "Duduk." },
  { id: 'd', symbol: "ã„·", read: "Digeut (D)", hint: "Kotak terbuka." },
  { id: 'r', symbol: "ã„¹", read: "Rieul (R/L)", hint: "Ular." },
  { id: 'm', symbol: "ã…", read: "Mieum (M)", hint: "Kotak." },
  { id: 'b', symbol: "ã…‚", read: "Bieup (B)", hint: "Ember." },
  { id: 's', symbol: "ã……", read: "Siot (S)", hint: "Orang berdiri." },
  { id: 'ng', symbol: "ã…‡", read: "Ieung (Ng)", hint: "Bulatan." },
  { id: 'j', symbol: "ã…ˆ", read: "Jieut (J)", hint: "Siot pakai topi." },
  { id: 'ch', symbol: "ã…Š", read: "Chieut (Ch)", hint: "Jieut pakai topi." },
  { id: 'k', symbol: "ã…‹", read: "Kieuk (K)", hint: "Pistol ada pelatuk." },
  { id: 't', symbol: "ã…Œ", read: "Tieut (T)", hint: "Sisir E." },
  { id: 'p', symbol: "ã…", read: "Pieup (P)", hint: "Pilar Romawi." },
  { id: 'h', symbol: "ã…Ž", read: "Hieut (H)", hint: "Orang pakai topi." },
  // Vokal (10 Dasar)
  { id: 'a', symbol: "ã…", read: "A", hint: "Tongkat tangan kanan." },
  { id: 'ya', symbol: "ã…‘", read: "Ya", hint: "Tongkat dua tangan kanan." },
  { id: 'eo', symbol: "ã…“", read: "Eo", hint: "Tongkat tangan kiri." },
  { id: 'yeo', symbol: "ã…•", read: "Yeo", hint: "Tongkat dua tangan kiri." },
  { id: 'o', symbol: "ã…—", read: "O", hint: "Tangan ke atas." },
  { id: 'yo', symbol: "ã…›", read: "Yo", hint: "Dua tangan ke atas." },
  { id: 'u', symbol: "ã…œ", read: "U", hint: "Tangan ke bawah." },
  { id: 'yu', symbol: "ã… ", read: "Yu", hint: "Dua tangan ke bawah." },
  { id: 'eu', symbol: "ã…¡", read: "Eu", hint: "Garis datar." },
  { id: 'i', symbol: "ã…£", read: "I", hint: "Garis tegak." }
];

const CHARS_HIRAGANA = [
  { symbol: "ã‚", read: "A", hint: "Ikan." }, { symbol: "ã„", read: "I", hint: "Dua garis." }, { symbol: "ã†", read: "U", hint: "Bungkuk." }, { symbol: "ãˆ", read: "E", hint: "Burung." }, { symbol: "ãŠ", read: "O", hint: "A + titik." },
  { symbol: "ã‹", read: "Ka", hint: "Kekuatan." }, { symbol: "ã", read: "Ki", hint: "Kunci." }, { symbol: "ã", read: "Ku", hint: "Mulut." }, { symbol: "ã‘", read: "Ke", hint: "Pedang." }, { symbol: "ã“", read: "Ko", hint: "Cacing." },
  { symbol: "ã•", read: "Sa", hint: "Senyum." }, { symbol: "ã—", read: "Shi", hint: "Kail." }, { symbol: "ã™", read: "Su", hint: "Simpul." }, { symbol: "ã›", read: "Se", hint: "Pangkuan." }, { symbol: "ã", read: "So", hint: "Zigzag." },
  { symbol: "ãŸ", read: "Ta", hint: "Ta + Ko." }, { symbol: "ã¡", read: "Chi", hint: "Lima." }, { symbol: "ã¤", read: "Tsu", hint: "Ombak." }, { symbol: "ã¦", read: "Te", hint: "Tangan." }, { symbol: "ã¨", read: "To", hint: "Duri." },
  { symbol: "ãª", read: "Na", hint: "Salib." }, { symbol: "ã«", read: "Ni", hint: "Garis + Ko." }, { symbol: "ã¬", read: "Nu", hint: "Mie." }, { symbol: "ã­", read: "Ne", hint: "Kucing." }, { symbol: "ã®", read: "No", hint: "Larangan." },
  { symbol: "ã¯", read: "Ha", hint: "Ha + Simpul." }, { symbol: "ã²", read: "Hi", hint: "Senyum V." }, { symbol: "ãµ", read: "Fu", hint: "Gunung Fuji." }, { symbol: "ã¸", read: "He", hint: "Gunung." }, { symbol: "ã»", read: "Ho", hint: "Ha + Topi." },
  { symbol: "ã¾", read: "Ma", hint: "Dua garis simpul." }, { symbol: "ã¿", read: "Mi", hint: "21." }, { symbol: "ã‚€", read: "Mu", hint: "Sapi (Moo)." }, { symbol: "ã‚", read: "Me", hint: "Mie (Nu) tanpa ekor." }, { symbol: "ã‚‚", read: "Mo", hint: "Kail dua umpan." },
  { symbol: "ã‚„", read: "Ya", hint: "Yakitori." }, { symbol: "ã‚†", read: "Yu", hint: "Ikan melintas." }, { symbol: "ã‚ˆ", read: "Yo", hint: "Yo-yo." },
  { symbol: "ã‚‰", read: "Ra", hint: "Angka 5." }, { symbol: "ã‚Š", read: "Ri", hint: "Dua garis." }, { symbol: "ã‚‹", read: "Ru", hint: "Tiga simpul." }, { symbol: "ã‚Œ", read: "Re", hint: "Z melengkung." }, { symbol: "ã‚", read: "Ro", hint: "Tiga (Ru) tanpa simpul." },
  { symbol: "ã‚", read: "Wa", hint: "Re gemuk." }, { symbol: "ã‚’", read: "Wo", hint: "Huruf C dan h." }, { symbol: "ã‚“", read: "N", hint: "Huruf h miring." }
].map((c, i) => ({ ...c, id: `hira_${i}` }));

const CHARS_KATAKANA = [
  { symbol: "ã‚¢", read: "A", hint: "T miring." }, { symbol: "ã‚¤", read: "I", hint: "Orang." }, { symbol: "ã‚¦", read: "U", hint: "Atap." }, { symbol: "ã‚¨", read: "E", hint: "I Romawi." }, { symbol: "ã‚ª", read: "O", hint: "Orang menari." },
  { symbol: "ã‚«", read: "Ka", hint: "Ka tanpa titik." }, { symbol: "ã‚­", read: "Ki", hint: "Dua garis." }, { symbol: "ã‚¯", read: "Ku", hint: "Tujuh." }, { symbol: "ã‚±", read: "Ke", hint: "K melengkung." }, { symbol: "ã‚³", read: "Ko", hint: "Siku." },
  { symbol: "ã‚µ", read: "Sa", hint: "Tiang." }, { symbol: "ã‚·", read: "Shi", hint: "Air ciprat." }, { symbol: "ã‚¹", read: "Su", hint: "Gantungan." }, { symbol: "ã‚»", read: "Se", hint: "Siku miring." }, { symbol: "ã‚½", read: "So", hint: "Jarum." },
  { symbol: "ã‚¿", read: "Ta", hint: "Sore (Yu)." }, { symbol: "ãƒ", read: "Chi", hint: "Seribu." }, { symbol: "ãƒ„", read: "Tsu", hint: "Senyum." }, { symbol: "ãƒ†", read: "Te", hint: "Dua garis." }, { symbol: "ãƒˆ", read: "To", hint: "Totem." },
  { symbol: "ãƒŠ", read: "Na", hint: "Pedang." }, { symbol: "ãƒ‹", read: "Ni", hint: "Dua." }, { symbol: "ãƒŒ", read: "Nu", hint: "Tujuh." }, { symbol: "ãƒ", read: "Ne", hint: "Pohon." }, { symbol: "ãƒŽ", read: "No", hint: "Coretan." },
  { symbol: "ãƒ", read: "Ha", hint: "Kumis." }, { symbol: "ãƒ’", read: "Hi", hint: "Kursi." }, { symbol: "ãƒ•", read: "Fu", hint: "Tujuh bengkok." }, { symbol: "ãƒ˜", read: "He", hint: "Gunung." }, { symbol: "ãƒ›", read: "Ho", hint: "Pohon salib." },
  { symbol: "ãƒž", read: "Ma", hint: "Siku 7." }, { symbol: "ãƒŸ", read: "Mi", hint: "Tiga garis." }, { symbol: "ãƒ ", read: "Mu", hint: "Segitiga." }, { symbol: "ãƒ¡", read: "Me", hint: "Silang." }, { symbol: "ãƒ¢", read: "Mo", hint: "Dua garis E." },
  { symbol: "ãƒ¤", read: "Ya", hint: "Tujuh miring." }, { symbol: "ãƒ¦", read: "Yu", hint: "Nomor 1." }, { symbol: "ãƒ¨", read: "Yo", hint: "E terbalik." },
  { symbol: "ãƒ©", read: "Ra", hint: "Topi." }, { symbol: "ãƒª", read: "Ri", hint: "Dua garis." }, { symbol: "ãƒ«", read: "Ru", hint: "Kaki." }, { symbol: "ãƒ¬", read: "Re", hint: "L." }, { symbol: "ãƒ­", read: "Ro", hint: "Kotak." },
  { symbol: "ãƒ¯", read: "Wa", hint: "Tanya." }, { symbol: "ãƒ²", read: "Wo", hint: "F." }, { symbol: "ãƒ³", read: "N", hint: "Senyum satu mata." }
].map((c, i) => ({ ...c, id: `kata_${i}` }));

const CHARS_JAVANESE = [
  { symbol: "ê¦²", read: "Ha", hint: "Ha" }, { symbol: "ê¦¤", read: "Na", hint: "Na" }, { symbol: "ê¦•", read: "Ca", hint: "Ca" }, { symbol: "ê¦«", read: "Ra", hint: "Ra" }, { symbol: "ê¦", read: "Ka", hint: "Ka" },
  { symbol: "ê¦¢", read: "Da", hint: "Da" }, { symbol: "ê¦ ", read: "Ta", hint: "Ta" }, { symbol: "ê¦±", read: "Sa", hint: "Sa" }, { symbol: "ê¦®", read: "Wa", hint: "Wa" }, { symbol: "ê¦­", read: "La", hint: "La" },
  { symbol: "ê¦¥", read: "Pa", hint: "Pa" }, { symbol: "ê¦", read: "Dha", hint: "Dha" }, { symbol: "ê¦—", read: "Ja", hint: "Ja" }, { symbol: "ê¦ª", read: "Ya", hint: "Ya" }, { symbol: "ê¦š", read: "Nya", hint: "Nya" },
  { symbol: "ê¦©", read: "Ma", hint: "Ma" }, { symbol: "ê¦’", read: "Ga", hint: "Ga" }, { symbol: "ê¦§", read: "Ba", hint: "Ba" }, { symbol: "ê¦›", read: "Tha", hint: "Tha" }, { symbol: "ê¦”", read: "Nga", hint: "Nga" }
].map((c, i) => ({ ...c, id: `java_${i}` }));

const CHARS_THAI = [
  { symbol: "à¸", read: "Ko Kai", hint: "Ayam." }, { symbol: "à¸‚", read: "Kho Khai", hint: "Telur." }, { symbol: "à¸ƒ", read: "Kho Khuad", hint: "Botol." }, { symbol: "à¸„", read: "Kho Khwai", hint: "Kerbau." }, { symbol: "à¸…", read: "Kho Khon", hint: "Orang." },
  { symbol: "à¸†", read: "Kho Rakhang", hint: "Lonceng." }, { symbol: "à¸‡", read: "Ngo Ngu", hint: "Ular." }, { symbol: "à¸ˆ", read: "Cho Chan", hint: "Piring." }, { symbol: "à¸‰", read: "Cho Ching", hint: "Simbal." }, { symbol: "à¸Š", read: "Cho Chang", hint: "Gajah." },
  { symbol: "à¸‹", read: "So So", hint: "Rantai." }, { symbol: "à¸Œ", read: "Cho Choe", hint: "Pohon." }, { symbol: "à¸", read: "Yo Ying", hint: "Wanita." }, { symbol: "à¸Ž", read: "Do Chada", hint: "Mahkota." }, { symbol: "à¸", read: "To Patak", hint: "Tombak." },
  { symbol: "à¸", read: "Tho Than", hint: "Peralatan." }, { symbol: "à¸‘", read: "Tho Montho", hint: "Raksasa." }, { symbol: "à¸’", read: "Tho Phuthao", hint: "Orang Tua." }, { symbol: "à¸“", read: "No Nen", hint: "Biksuni." }, { symbol: "à¸”", read: "Do Dek", hint: "Anak." },
  { symbol: "à¸•", read: "To Tao", hint: "Kura-kura." }, { symbol: "à¸–", read: "Tho Thung", hint: "Tas." }, { symbol: "à¸—", read: "Tho Thahan", hint: "Tentara." }, { symbol: "à¸˜", read: "Tho Thong", hint: "Bendera." }, { symbol: "à¸™", read: "No Nu", hint: "Tikus." },
  { symbol: "à¸š", read: "Bo Baimai", hint: "Daun." }, { symbol: "à¸›", read: "Po Pla", hint: "Ikan." }, { symbol: "à¸œ", read: "Pho Phueng", hint: "Lebah." }, { symbol: "à¸", read: "Fo Fa", hint: "Tutup." }, { symbol: "à¸ž", read: "Pho Phan", hint: "Nampan." },
  { symbol: "à¸Ÿ", read: "Fo Fan", hint: "Gigi." }, { symbol: "à¸ ", read: "Pho Samphao", hint: "Perahu Layar." }, { symbol: "à¸¡", read: "Mo Ma", hint: "Kuda." }, { symbol: "à¸¢", read: "Yo Yak", hint: "Raksasa." }, { symbol: "à¸£", read: "Ro Ruea", hint: "Perahu." },
  { symbol: "à¸¥", read: "Lo Ling", hint: "Monyet." }, { symbol: "à¸§", read: "Wo Waen", hint: "Cincin." }, { symbol: "à¸¨", read: "So Sala", hint: "Paviliun." }, { symbol: "à¸©", read: "So Ruesi", hint: "Pertapa." }, { symbol: "à¸ª", read: "So Suea", hint: "Harimau." },
  { symbol: "à¸«", read: "Ho Hip", hint: "Kotak." }, { symbol: "à¸¬", read: "Lo Chula", hint: "Layang-layang." }, { symbol: "à¸­", read: "O Ang", hint: "Baskom." }, { symbol: "à¸®", read: "Ho Nokhuk", hint: "Burung Hantu." }
].map((c, i) => ({ ...c, id: `thai_${i}` }));


const LANGUAGE_DATA = {
  alphabet: {
    name: "Alphabet (26)",
    langCode: "en-US",
    fontFamily: "sans-serif",
    stages: createStages(CHARS_ALPHABET)
  },
  arabic: {
    name: "Arab (28)",
    langCode: "ar-SA",
    fontFamily: "serif",
    stages: createStages(CHARS_ARABIC)
  },
  javanese: {
    name: "Aksara Jawa (20)",
    langCode: "jv-ID", // Support di beberapa browser
    fontFamily: "'Noto Sans Javanese', serif",
    stages: createStages(CHARS_JAVANESE)
  },
  hangul: {
    name: "Korea Hangul (24)",
    langCode: "ko-KR",
    fontFamily: "sans-serif",
    stages: createStages(CHARS_HANGUL)
  },
  hiragana: {
    name: "Jepang Hiragana (46)",
    langCode: "ja-JP",
    fontFamily: "sans-serif",
    stages: createStages(CHARS_HIRAGANA)
  },
  katakana: {
    name: "Jepang Katakana (46)",
    langCode: "ja-JP",
    fontFamily: "sans-serif",
    stages: createStages(CHARS_KATAKANA)
  },
  thai: {
    name: "Aksara Thai (44)",
    langCode: "th-TH",
    fontFamily: "'Noto Sans Thai', sans-serif",
    stages: createStages(CHARS_THAI)
  }
};

/**
 * ENGINE DRILL (30 ITEMS - IQRO METHOD)
 * Logic:
 * Stage 1: 100% Huruf Baru.
 * Stage >1: 70% Huruf Baru (Diulang-ulang), 30% Huruf Lama (Random Review).
 */
const generateDrillQueue = (langData, stageId) => {
  const currentStage = langData.stages.find(s => s.id === stageId);
  const prevStages = langData.stages.filter(s => s.id < stageId);
  
  const DRILL_COUNT = 30;
  let queue = [];

  if (!currentStage) return [];

  // Karena struktur baru 1 level = 1 huruf, maka newChars selalu cuma 1 item.
  const targetChar = currentStage.newChars[0];
  
  // Kumpulkan huruf lama untuk review
  let oldChars = [];
  prevStages.forEach(s => {
    oldChars = [...oldChars, ...s.newChars];
  });

  for (let i = 0; i < DRILL_COUNT; i++) {
    let char;
    
    if (stageId === 1) {
       // Stage 1: Full Target
       char = targetChar;
    } else {
       // Stage > 1: Mix
       // Pola: Baru, Baru, Lama, Baru, Baru, Lama... (2:1 Ratio)
       const isReview = oldChars.length > 0 && ((i + 1) % 3 === 0);
       
       if (isReview) {
         char = oldChars[Math.floor(Math.random() * oldChars.length)];
       } else {
         char = targetChar;
       }
    }

    queue.push({ 
        ...char, 
        uniqueId: `drill-${stageId}-${i}`, 
        userImage: null 
    });
  }
  return queue;
};

const App = () => {
  const [activeLangKey, setActiveLangKey] = useState('alphabet'); 
  const [activeStageId, setActiveStageId] = useState(1);
  
  const [drillQueue, setDrillQueue] = useState([]);
  const [currentDrillIndex, setCurrentDrillIndex] = useState(0);
  
  // Drawing State
  const [userStrokes, setUserStrokes] = useState([]); 
  const [isDrawing, setIsDrawing] = useState(false);
  const [currentStroke, setCurrentStroke] = useState([]);

  const [feedback, setFeedback] = useState("");
  const [leftSidebarOpen, setLeftSidebarOpen] = useState(false);
  const [rightSidebarOpen, setRightSidebarOpen] = useState(true);
  const [showConfetti, setShowConfetti] = useState(false);

  const canvasRef = useRef(null);

  const currentLangData = LANGUAGE_DATA[activeLangKey];
  const currentStage = currentLangData.stages.find(s => s.id === activeStageId) || currentLangData.stages[0];
  const currentTaskChar = drillQueue[currentDrillIndex];

  // TTS Helper
  const speak = (text) => {
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = currentLangData.langCode;
        utterance.rate = 0.8; 
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
    }
  };

  // Play audio when char changes
  useEffect(() => {
    if (currentTaskChar) {
        setFeedback(currentTaskChar.hint);
    }
  }, [currentTaskChar]);

  // Responsive Init
  useEffect(() => {
    const handleResize = () => {
      if (window.innerWidth < 1024) {
        setRightSidebarOpen(false); 
      } else {
        setRightSidebarOpen(true); 
      }
    };
    handleResize(); 
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  // Init Drill
  useEffect(() => {
    // Reset ke stage 1 jika ganti bahasa
    setActiveStageId(1);
  }, [activeLangKey]);

  useEffect(() => {
    const queue = generateDrillQueue(currentLangData, activeStageId);
    setDrillQueue(queue);
    setCurrentDrillIndex(0);
    setUserStrokes([]);
    setCurrentStroke([]);
    setFeedback("Tebalkan huruf bercahaya di layar.");
  }, [activeLangKey, activeStageId]);

  // RENDER CANVAS
  useEffect(() => {
    if (!currentTaskChar) return;
    const canvas = canvasRef.current;
    if (!canvas) return;
    
    const rect = canvas.getBoundingClientRect();
    if (canvas.width !== rect.width || canvas.height !== rect.height) {
        canvas.width = rect.width;
        canvas.height = rect.height;
    }

    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;
    
    ctx.clearRect(0, 0, w, h);
    
    // 1. GRID
    drawGrid(ctx, w, h);

    // 2. GLOWING GHOST CHARACTER
    ctx.save();
    // Adjust font size for long text (like some Thai chars are tall)
    const fontSize = w * 0.60;
    const fontFamily = currentLangData.fontFamily || "sans-serif";
    ctx.font = `bold ${fontSize}px ${fontFamily}, "Noto Sans", "Arial"`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    
    // Glowing Effect
    ctx.shadowColor = "#58D68D"; 
    ctx.shadowBlur = 20;
    ctx.fillStyle = "rgba(88, 214, 141, 0.25)"; 
    
    const yOffset = h * 0.05; 
    ctx.fillText(currentTaskChar.symbol, w / 2, h / 2 + yOffset);
    
    ctx.strokeStyle = "rgba(88, 214, 141, 0.4)";
    ctx.lineWidth = 1;
    ctx.strokeText(currentTaskChar.symbol, w / 2, h / 2 + yOffset);
    
    ctx.restore();

    // 3. USER INK
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.globalAlpha = 1.0;
    ctx.strokeStyle = '#1e293b'; 
    ctx.lineWidth = 16; 
    
    userStrokes.forEach(strokePoints => {
        drawUserPath(ctx, strokePoints);
    });

    if (currentStroke.length > 0) {
        drawUserPath(ctx, currentStroke);
    }

  }, [drillQueue, currentDrillIndex, userStrokes, currentStroke, activeLangKey]);

  // --- HELPERS ---
  const drawGrid = (ctx, w, h) => {
    ctx.save();
    ctx.beginPath();
    ctx.strokeStyle = '#58D68D'; 
    ctx.lineWidth = 1;
    ctx.globalAlpha = 0.3; 
    
    const padding = 15;
    ctx.rect(padding, padding, w-(padding*2), h-(padding*2));
    
    ctx.setLineDash([8, 8]);
    ctx.moveTo(w/2, padding); ctx.lineTo(w/2, h-padding);
    ctx.moveTo(padding, h/2); ctx.lineTo(w-padding, h/2);
    
    // Diagonal lines for complicated chars
    if (currentLangData.fontFamily.includes('serif') || activeLangKey !== 'alphabet') {
        ctx.moveTo(padding, padding); ctx.lineTo(w-padding, h-padding);
        ctx.moveTo(w-padding, padding); ctx.lineTo(padding, h-padding);
    }
    
    ctx.stroke();
    ctx.restore();
  };

  const drawUserPath = (ctx, points) => {
    if(points.length < 2) {
        if(points.length === 1) {
            ctx.beginPath();
            ctx.arc(points[0].x, points[0].y, ctx.lineWidth/2, 0, Math.PI*2);
            ctx.fill();
        }
        return;
    }
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);
    for(let i = 1; i < points.length; i++) {
         ctx.lineTo(points[i].x, points[i].y);
    }
    ctx.stroke();
  };

  const getCoords = (e) => {
    const canvas = canvasRef.current;
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return {
        x: clientX - rect.left,
        y: clientY - rect.top
    };
  };

  const startDrawing = (e) => {
    if (currentDrillIndex >= drillQueue.length) return;
    if (e.cancelable) e.preventDefault(); 
    setIsDrawing(true);
    const coords = getCoords(e);
    setCurrentStroke([coords]);
  };

  const draw = (e) => {
    if (!isDrawing) return;
    if (e.cancelable) e.preventDefault();
    const coords = getCoords(e);
    setCurrentStroke(prev => [...prev, coords]);
  };

  const endDrawing = () => {
    if (!isDrawing) return;
    setIsDrawing(false);
    if (currentStroke.length > 0) {
        setUserStrokes(prev => [...prev, currentStroke]);
    }
    setCurrentStroke([]);
  };

  // --- ACTIONS ---
  const handleClear = () => {
    setUserStrokes([]);
    setCurrentStroke([]);
  };

  const saveToNotebook = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const dataUrl = canvas.toDataURL('image/png');
    const updatedQueue = [...drillQueue];
    updatedQueue[currentDrillIndex].userImage = dataUrl;
    setDrillQueue(updatedQueue);
  };

  const handleNext = () => {
    saveToNotebook();
    if (currentDrillIndex < drillQueue.length - 1) {
        setCurrentDrillIndex(prev => prev + 1);
        setUserStrokes([]);
        setFeedback(currentTaskChar.hint); 
    } else {
        setFeedback("Stage Selesai!");
        setShowConfetti(true);
        setTimeout(() => setShowConfetti(false), 3000);
        setRightSidebarOpen(true);
    }
  };

  const handlePrint = () => {
    window.print();
  };

  if (!currentTaskChar) return <div className="p-10 flex justify-center text-emerald-500">Memuat Aset...</div>;

  return (
    <div className="min-h-screen bg-[#E9F7EF] font-sans text-slate-800 flex flex-col overflow-hidden select-none">
      
      {/* CSS PRINTING */}
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Javanese&family=Noto+Sans+Thai:wght@400;700&display=swap');
        
        @media print {
          @page { margin: 1cm; size: A4; }
          body { background: white; }
          header, aside, .tools-panel, .action-buttons, .canvas-tools, .canvas-container, .audio-btn { display: none !important; }
          .notebook-section { 
            position: relative !important; 
            width: 100% !important; 
            height: auto !important; 
            overflow: visible !important;
            border: none !important;
            background: white !important;
            transform: none !important;
            display: block !important;
          }
          .notebook-grid {
            display: grid !important;
            grid-template-columns: repeat(5, 1fr) !important;
            gap: 10px !important;
          }
          .notebook-item {
            border: 1px solid #ccc !important;
            break-inside: avoid;
            background: white !important;
          }
          .print-header { display: block !important; text-align: center; margin-bottom: 20px; }
          .notebook-title { display: none; }
        }
        .print-header { display: none; }
      `}</style>

      {/* HEADER */}
      <header className="bg-white border-b border-[#D5F5E3] px-4 py-3 flex justify-between items-center z-20 shadow-sm h-16 shrink-0">
        <div className="flex items-center gap-3">
           <button onClick={() => setLeftSidebarOpen(!leftSidebarOpen)} className="p-2 hover:bg-[#E9F7EF] rounded-lg lg:hidden text-emerald-700">
             <Menu size={24} />
           </button>
           <div className="w-9 h-9 bg-[#58D68D] rounded-xl flex items-center justify-center text-white shadow-md shadow-emerald-100">
             <Globe size={20} />
           </div>
           <div>
             <h1 className="font-bold text-lg leading-none tracking-tight text-emerald-900">GlobalScript</h1>
             <p className="text-[10px] text-emerald-600 font-medium tracking-wider">IQRO METHOD</p>
           </div>
        </div>

        <div className="flex items-center gap-2">
           <div className="hidden sm:flex px-3 py-1 bg-[#E9F7EF] rounded-full text-xs font-bold text-emerald-700 border border-[#D5F5E3]">
              {currentLangData.name}
           </div>
           <button 
             onClick={() => setRightSidebarOpen(!rightSidebarOpen)}
             className="relative p-2 hover:bg-[#E9F7EF] rounded-lg text-emerald-700 lg:hidden"
           >
              <Book size={24} />
              <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-[#58D68D] rounded-full border border-white"></span>
           </button>
        </div>
      </header>

      {/* BODY */}
      <div className="flex flex-1 overflow-hidden relative">
        
        {/* LEFT SIDEBAR (MENU) */}
        <aside className={`
          absolute lg:relative z-30 h-full w-64 bg-white border-r border-[#D5F5E3] flex flex-col transition-transform duration-300 shadow-xl lg:shadow-none
          ${leftSidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
        `}>
           <div className="p-4 border-b border-[#E9F7EF] flex justify-between items-center lg:hidden">
              <span className="font-bold text-emerald-800">Menu Belajar</span>
              <button onClick={() => setLeftSidebarOpen(false)}><X size={20} className="text-emerald-500"/></button>
           </div>
           
           <div className="flex-1 overflow-y-auto p-4 space-y-6">
             {/* Language Selector */}
             <div>
               <h3 className="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-2">Pilih Aksara</h3>
               <div className="grid grid-cols-1 gap-2">
                 {Object.keys(LANGUAGE_DATA).map(key => (
                   <button
                     key={key}
                     onClick={() => { setActiveLangKey(key); setLeftSidebarOpen(false); }}
                     className={`p-3 rounded-xl text-sm font-medium border text-left flex justify-between items-center transition-all ${
                       activeLangKey === key 
                       ? 'bg-[#E9F7EF] text-emerald-800 border-[#58D68D] shadow-sm' 
                       : 'bg-white text-slate-500 border-slate-100 hover:bg-[#E9F7EF]'
                     }`}
                   >
                     {LANGUAGE_DATA[key].name}
                     {activeLangKey === key && <CheckCircle size={16} className="text-[#58D68D]" />}
                   </button>
                 ))}
               </div>
             </div>

             {/* Stage Selector */}
             <div>
                <div className="flex justify-between items-center mb-2">
                   <h3 className="text-xs font-bold text-emerald-400 uppercase tracking-wider">Pilih Huruf</h3>
                   <span className="text-[10px] bg-slate-100 px-2 rounded-full text-slate-500">{currentLangData.stages.length} Level</span>
                </div>
                
                <div className="space-y-1 max-h-[40vh] overflow-y-auto pr-1 custom-scrollbar">
                  {currentLangData.stages.map(stage => (
                    <button
                      key={stage.id}
                      onClick={() => { setActiveStageId(stage.id); setLeftSidebarOpen(false); }}
                      className={`w-full text-left p-2.5 rounded-xl text-sm flex items-center gap-3 transition-colors ${
                        activeStageId === stage.id 
                        ? 'bg-[#58D68D] text-white font-bold shadow-md shadow-emerald-100' 
                        : 'text-slate-500 hover:bg-[#E9F7EF]'
                      }`}
                    >
                      <div className={`w-6 h-6 shrink-0 rounded-full flex items-center justify-center text-[10px] font-bold border ${
                         activeStageId === stage.id ? 'bg-white text-[#58D68D]' : 'bg-slate-100 border-slate-200'
                      }`}>
                        {stage.id}
                      </div>
                      <span className="truncate">{stage.title}</span>
                    </button>
                  ))}
                </div>
             </div>
           </div>
        </aside>

        {/* CENTER: CANVAS WORKSPACE */}
        <main className="flex-1 flex flex-col items-center justify-start p-4 lg:p-6 relative overflow-y-auto">
             {showConfetti && (
               <div className="absolute inset-0 flex items-center justify-center z-50 pointer-events-none animate-bounce">
                 <span className="text-8xl filter drop-shadow-lg">ðŸŒŸ</span>
               </div>
             )}

             <div className="mb-4 text-center canvas-tools">
                <span className="bg-[#D5F5E3] px-4 py-1.5 rounded-full text-emerald-800 text-xs uppercase tracking-widest font-bold border border-[#58D68D] shadow-sm">
                   Level {activeStageId}: {currentTaskChar.read}
                </span>
             </div>

             {/* THE CANVAS */}
             <div className="relative group touch-none canvas-container select-none">
                <div className="bg-white p-2 rounded-[2rem] shadow-2xl shadow-emerald-100 border-4 border-white ring-2 ring-[#D5F5E3] mb-6 transition-transform duration-300">
                  <canvas
                    ref={canvasRef}
                    width={320} 
                    height={320}
                    className="bg-white rounded-[1.8rem] cursor-crosshair touch-none w-[300px] h-[300px] sm:w-[380px] sm:h-[380px]"
                    onMouseDown={startDrawing}
                    onMouseMove={draw}
                    onMouseUp={endDrawing}
                    onMouseLeave={endDrawing}
                    onTouchStart={startDrawing}
                    onTouchMove={draw}
                    onTouchEnd={endDrawing}
                  />
                  
                  {/* Spelling / Reading Overlay */}
                  <div className="absolute top-4 left-6 pointer-events-none">
                     <span className="bg-white/90 backdrop-blur px-3 py-1 rounded-lg text-lg font-bold text-slate-700 shadow-sm border border-slate-200">
                       {currentTaskChar.read}
                     </span>
                  </div>

                  {/* Audio Button */}
                  <div className="absolute top-4 right-4 pointer-events-auto audio-btn">
                     <button 
                        onClick={() => speak(currentTaskChar.read)}
                        className="p-2 bg-emerald-100 hover:bg-emerald-200 text-emerald-700 rounded-full shadow-sm transition-colors"
                        title="Dengar Suara"
                     >
                        <Volume2 size={24} />
                     </button>
                  </div>
                </div>
                
                {/* Floating Clear Button */}
                <div className="absolute bottom-10 right-6 flex flex-col gap-2 pointer-events-auto">
                   <button 
                     onClick={handleClear}
                     className="p-3 bg-white text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full shadow-md border border-slate-100 transition-all active:scale-90"
                     title="Hapus"
                   >
                     <Eraser size={22} />
                   </button>
                </div>
             </div>

             {/* Action Buttons */}
             <div className="flex flex-col sm:flex-row gap-3 w-full max-w-sm action-buttons">
                 <button
                    onClick={handleClear}
                    className="flex-1 py-3.5 rounded-2xl font-bold border-2 border-[#D5F5E3] text-emerald-700 hover:bg-[#E9F7EF] transition-colors flex items-center justify-center gap-2"
                 >
                    <RotateCcw size={20} /> Ulang
                 </button>

                 <button
                    onClick={handleNext}
                    disabled={currentDrillIndex >= drillQueue.length}
                    className={`
                      flex-[2] py-3.5 rounded-2xl text-lg font-bold shadow-lg shadow-emerald-200 transition-all active:scale-95 flex items-center justify-center gap-2
                      ${currentDrillIndex >= drillQueue.length
                        ? 'bg-slate-400 text-white cursor-default'
                        : 'bg-[#58D68D] hover:bg-[#4ac77d] text-white'
                      }
                    `}
                 >
                    {currentDrillIndex >= drillQueue.length ? (
                      <>Selesai! <CheckCircle className="ml-1"/></>
                    ) : (
                      <>Selesai & Lanjut <ChevronRight size={22} /></>
                    )}
                 </button>
             </div>

             <p className="mt-6 text-emerald-600/70 text-sm font-medium text-center max-w-xs leading-relaxed min-h-[1.5rem]">
               Tips: {feedback}
             </p>
        </main>

        {/* RIGHT SIDEBAR (NOTEBOOK) */}
        <aside className={`
          notebook-section absolute lg:relative z-40 top-0 right-0 h-full w-80 bg-white border-l border-[#D5F5E3] flex flex-col transition-transform duration-300 shadow-2xl lg:shadow-none
          ${rightSidebarOpen ? 'translate-x-0' : 'translate-x-full lg:translate-x-0'}
        `}>
             <div className="print-header">
               <h1 className="text-2xl font-bold text-emerald-800">Laporan Belajar</h1>
               <p className="text-slate-500">{new Date().toLocaleDateString()} - {currentLangData.name} - Level {activeStageId}</p>
             </div>

             <div className="p-5 bg-[#E9F7EF] border-b border-[#D5F5E3] shadow-sm z-10 flex justify-between items-start notebook-title">
               <div>
                 <h2 className="font-bold text-emerald-800 flex items-center gap-2 text-sm uppercase tracking-wide">
                   <Book size={18} className="text-[#58D68D]"/>
                   Buku Latihan
                 </h2>
                 <p className="text-xs text-emerald-600 mt-1">
                   {currentDrillIndex} dari {drillQueue.length} halaman
                 </p>
               </div>
               <button onClick={() => setRightSidebarOpen(false)} className="lg:hidden text-emerald-500">
                  <X size={24}/>
               </button>
             </div>

             <div className="flex-1 overflow-y-auto p-4 custom-scrollbar bg-slate-50/50">
               <div className="grid grid-cols-2 gap-3 pb-20 notebook-grid">
                 {drillQueue.map((item, idx) => {
                   const status = idx < currentDrillIndex ? 'done' : idx === currentDrillIndex ? 'active' : 'pending';
                   
                   return (
                     <div 
                       key={item.uniqueId}
                       className={`
                         notebook-item aspect-square rounded-2xl flex items-center justify-center relative transition-all duration-500 overflow-hidden bg-white
                         ${status === 'done' ? 'border-2 border-[#58D68D] shadow-sm' : ''}
                         ${status === 'active' ? 'border-2 border-emerald-300 ring-4 ring-emerald-50 z-10' : ''}
                         ${status === 'pending' ? 'border-2 border-slate-100 opacity-60' : ''}
                       `}
                     >
                        {item.userImage ? (
                          <img 
                            src={item.userImage} 
                            alt="Hasil Anak" 
                            className="w-full h-full object-contain p-1"
                          />
                        ) : (
                          <span className={`text-5xl font-bold ${
                              status === 'pending' ? 'text-slate-200' : 'text-emerald-200'
                            }`}
                            style={{ fontFamily: currentLangData.fontFamily || 'sans-serif' }}
                          >
                            {item.symbol}
                          </span>
                        )}
                        
                        <span className={`absolute top-2 left-2 text-[10px] font-bold px-1.5 py-0.5 rounded-full ${
                          status==='active' ? 'bg-[#58D68D] text-white' : 'bg-slate-100 text-slate-400'
                        }`}>
                          {idx + 1}
                        </span>
                     </div>
                   );
                 })}
               </div>
             </div>

             {/* Footer Button for Print */}
             <div className="p-4 border-t border-[#D5F5E3] bg-white notebook-title">
               <button 
                 onClick={handlePrint}
                 className="w-full py-3 rounded-xl border-2 border-[#58D68D] text-[#58D68D] font-bold hover:bg-[#E9F7EF] flex items-center justify-center gap-2 transition-colors"
               >
                 <Printer size={20} />
                 Cetak / Simpan PDF
               </button>
             </div>
        </aside>

      </div>
    </div>
  );
};

export default App;
